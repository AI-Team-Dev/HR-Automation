name: Deploy to Render

on:
  push:
    branches:
      - production
      - development

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      RENDER_API_BASE: https://api.render.com/v1

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # OPTIONAL: Build step (if your project needs it)
      - name: Build project
        run: |
          echo "Building project..."
          # Add real build if needed (e.g., npm install && npm run build)
          # For Python: pip install -r requirements.txt
          # For React: npm ci && npm run build

      - name: Trigger Render Deploy
        id: trigger
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "üöÄ Triggering Render deploy..."

          response=$(curl -s -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            "$RENDER_API_BASE/services/$RENDER_SERVICE_ID/deploys" \
            -d '{}')

          echo "Render API Response:"
          echo "$response"

          deploy_id=$(echo "$response" | jq -r '.id')

          if [ -z "$deploy_id" ] || [ "$deploy_id" == "null" ]; then
            echo "‚ùå Failed to trigger deployment!"
            exit 1
          fi

          echo "Deploy ID: $deploy_id"
          echo "deploy_id=$deploy_id" >> $GITHUB_OUTPUT

      - name: Wait for Deployment to Complete
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          DEPLOY_ID: ${{ steps.trigger.outputs.deploy_id }}
        run: |
          echo "‚è≥ Waiting for Render deploy to finish..."

          max_wait=900   # 15 minutes
          interval=10
          elapsed=0

          while [ $elapsed -lt $max_wait ]; do
            status_response=$(curl -s \
              -H "Authorization: Bearer $RENDER_API_KEY" \
              "$RENDER_API_BASE/services/$RENDER_SERVICE_ID/deploys/$DEPLOY_ID")

            status=$(echo "$status_response" | jq -r '.status')

            echo "üîÑ Deploy Status: $status (elapsed: ${elapsed}s)"

            if [ "$status" == "succeeded" ]; then
              echo "üéâ Deploy Succeeded!"
              exit 0
            fi

            if [ "$status" == "failed" ]; then
              echo "‚ùå Deployment Failed!"
              echo "Full response:"
              echo "$status_response"
              exit 1
            fi

            sleep $interval
            elapsed=$((elapsed + interval))
          done

          echo "‚ùå Deployment timed out!"
          exit 1
